<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <title>DECA Master - AI Exam Prep</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCxdHiRi9kq5W-nJnLdfvC1oZ30VPnqJKA",
            authDomain: "aidecaexams.firebaseapp.com",
            projectId: "aidecaexams",
            storageBucket: "aidecaexams.firebasestorage.app",
            messagingSenderId: "895592591782",
            appId: "1:895592591782:web:5be5205a1743d898589f67",
            measurementId: "G-7J65GMHNBD"
        };

        let db, auth, userId;

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            signInAnonymously(auth).catch(console.error);
            onAuthStateChanged(auth, u => userId = u ? u.uid : null);
        } catch (e) { console.warn("Firebase Init Error:", e); }

        window.saveExam = async (data) => {
            if (!db) return;
            try {
                await addDoc(collection(db, 'exam_submissions'), {
                    ...data,
                    timestamp: Timestamp.now(),
                    userId: userId
                });
            } catch (e) { console.error("Save Error:", e); }
        };

        window.loadSubmissions = async () => {
            if (!db) return [];
            try {
                const q = query(collection(db, 'exam_submissions'), orderBy('timestamp', 'desc'));
                const snap = await getDocs(q);
                return snap.docs.map(d => ({id: d.id, ...d.data()}));
            } catch (e) { return []; }
        };
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Print Styles */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; color: black; overflow: visible; height: auto; }
            #main-stage { overflow: visible !important; }
            .page-break { break-after: page; }
        }

        .option-card { transition: all 0.2s; }
        .option-card:hover { border-color: #3b82f6; background-color: #eff6ff; }
        .option-card.selected { background-color: #eff6ff; border-color: #2563eb; ring: 2px solid #2563eb; }
        
        .nav-item.active { background-color: #eff6ff; border-color: #3b82f6; color: #1d4ed8; }
        .nav-item.answered { border-left-color: #22c55e; }
        .nav-item.flagged { border-right-color: #ef4444; border-right-width: 4px; }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="bg-blue-900 text-white shadow-lg z-20 flex-shrink-0 h-16 flex items-center justify-between px-6 no-print">
        <div class="flex items-center gap-3">
            <div class="bg-yellow-400 text-blue-900 px-2 py-1 rounded font-black text-lg tracking-tighter">DECA</div>
            <h1 class="text-lg font-bold tracking-tight text-blue-100">Exam Prep</h1>
        </div>
        
        <div class="flex items-center gap-6">
            <!-- Timer -->
            <div id="timer-box" class="hidden bg-blue-800/50 px-4 py-1.5 rounded-lg border border-blue-700/50 flex items-center gap-2">
                <i class="far fa-clock text-blue-300"></i>
                <span id="timer-display" class="font-mono font-bold text-lg tracking-widest text-white">90:00</span>
            </div>

            <!-- Admin -->
            <button onclick="app.toggleAdmin()" class="text-blue-300 hover:text-white transition p-2 rounded hover:bg-blue-800">
                <i class="fas fa-lock"></i>
            </button>
        </div>
    </header>

    <!-- Main App -->
    <div class="flex flex-grow overflow-hidden relative">
        
        <!-- SIDEBAR -->
        <aside id="sidebar" class="w-72 bg-white border-r border-slate-200 flex-col hidden md:flex no-print transition-all duration-300">
            <div class="p-4 border-b border-slate-100 bg-slate-50">
                <h3 class="font-bold text-slate-700 text-xs uppercase tracking-wider mb-2">Navigator</h3>
                <div class="flex justify-between text-[10px] text-slate-500 font-medium">
                    <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-green-500"></div> Answered</span>
                    <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-red-500"></div> Flagged</span>
                </div>
            </div>
            
            <div id="nav-grid" class="flex-grow overflow-y-auto p-2 grid grid-cols-5 gap-1 content-start">
                <!-- Nav Items Injected Here -->
            </div>

            <div class="p-4 border-t border-slate-200 bg-slate-50">
                <button onclick="app.showReview()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg text-sm shadow-sm transition">
                    Review & Submit
                </button>
                <button onclick="app.cancelExam()" class="w-full mt-2 text-red-600 hover:text-red-700 text-xs font-bold py-2 transition">
                    Cancel Exam
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main id="main-stage" class="flex-grow overflow-y-auto bg-slate-50 relative w-full p-6">

            <!-- 1. CONFIG VIEW -->
            <div id="view-config" class="max-w-2xl mx-auto mt-10">
                <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                    <div class="bg-blue-900 p-6 text-white">
                        <h2 class="text-2xl font-bold">New Exam Session</h2>
                        <p class="text-blue-200 text-sm">Select your cluster to generate a blueprint-aligned practice test.</p>
                    </div>
                    
                    <div class="p-8 space-y-6">
                        <!-- Cluster -->
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Career Cluster</label>
                            <select id="sel-cluster" class="w-full p-3 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="">Select...</option>
                                <!-- JS Populated -->
                            </select>
                        </div>

                        <!-- Event -->
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Event</label>
                            <select id="sel-event" class="w-full p-3 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none" disabled>
                                <option>Select Cluster First...</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <!-- Level -->
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Level</label>
                                <select id="sel-level" class="w-full p-3 border border-slate-300 rounded-lg text-sm bg-white">
                                    <option value="District">District</option>
                                    <option value="Association">Association (State)</option>
                                    <option value="ICDC">ICDC</option>
                                </select>
                            </div>
                            <!-- Questions -->
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Questions</label>
                                <select id="sel-count" class="w-full p-3 border border-slate-300 rounded-lg text-sm bg-white">
                                    <option value="10">10 (Warmup)</option>
                                    <option value="25">25 (Practice)</option>
                                    <option value="50">50 (Half Exam)</option>
                                    <option value="100">100 (Full Exam)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Name -->
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Student Name</label>
                            <input type="text" id="inp-name" class="w-full p-3 border border-slate-300 rounded-lg text-sm" placeholder="Enter Full Name">
                        </div>

                        <button onclick="app.startExam()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-md transition transform active:scale-95 flex justify-center items-center gap-2">
                            <span>Start Exam</span>
                            <i class="fas fa-play text-xs"></i>
                        </button>
                        
                        <!-- Status Messages -->
                        <div id="status-msg" class="hidden text-center text-sm py-2 rounded bg-slate-100 text-slate-600"></div>
                        <div id="error-msg" class="hidden text-center text-sm py-2 rounded bg-red-100 text-red-600 border border-red-200 mt-2"></div>
                    </div>
                </div>
            </div>

            <!-- 2. EXAM VIEW -->
            <div id="view-exam" class="hidden h-full flex flex-col max-w-5xl mx-auto">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex-grow flex flex-col overflow-hidden">
                    
                    <!-- Question Header -->
                    <div class="p-6 border-b border-slate-100 flex justify-between items-start">
                        <div>
                            <span id="q-area" class="inline-block bg-indigo-50 text-indigo-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider mb-2">Category</span>
                            <div class="text-slate-400 text-xs font-bold uppercase tracking-widest">Question <span id="q-num">1</span> of <span id="q-total">50</span></div>
                        </div>
                        <button onclick="app.toggleFlag()" id="btn-flag" class="text-slate-300 hover:text-red-500 transition">
                            <i class="fas fa-flag text-xl"></i>
                        </button>
                    </div>

                    <!-- Content -->
                    <div class="p-8 md:p-12 overflow-y-auto flex-grow">
                        <h2 id="q-text" class="text-xl md:text-2xl font-bold text-slate-800 leading-snug mb-8">Loading...</h2>
                        <div id="q-options" class="space-y-3 max-w-3xl">
                            <!-- Options Injected Here -->
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="p-4 border-t border-slate-100 bg-slate-50 flex justify-between items-center no-print">
                        <button onclick="app.nav(-1)" class="px-6 py-2 rounded-lg border border-slate-300 text-slate-600 font-bold text-sm hover:bg-white transition">Back</button>
                        <button onclick="app.nav(1)" class="px-6 py-2 rounded-lg bg-blue-600 text-white font-bold text-sm hover:bg-blue-700 shadow-sm transition">Next</button>
                    </div>
                </div>
            </div>

            <!-- 3. REVIEW VIEW -->
            <div id="view-review" class="hidden max-w-5xl mx-auto">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">Review Answers</h2>
                <div id="review-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                    <!-- Cards -->
                </div>
                <div class="flex justify-end gap-4">
                    <button onclick="app.resume()" class="px-6 py-2 border border-slate-300 rounded-lg font-bold text-slate-600 hover:bg-white">Return to Exam</button>
                    <button onclick="app.submit()" class="px-6 py-2 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 shadow-md">Submit Final Answers</button>
                </div>
            </div>

            <!-- 4. RESULTS VIEW -->
            <div id="view-results" class="hidden max-w-4xl mx-auto">
                <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden mb-8">
                    <div class="bg-slate-900 text-white p-8 text-center">
                        <p class="uppercase text-xs font-bold tracking-widest text-slate-400 mb-2">Final Score</p>
                        <h1 id="res-score" class="text-6xl font-black mb-2">0%</h1>
                        <p id="res-detail" class="text-slate-300">0/0 Correct</p>
                    </div>
                    
                    <div class="p-4 bg-slate-50 border-b border-slate-200 flex justify-center gap-3 no-print">
                        <button onclick="app.printResults()" class="px-4 py-2 bg-white border border-slate-300 rounded text-sm font-bold text-slate-700 hover:bg-slate-50">
                            <i class="fas fa-print mr-2"></i> Print Report
                        </button>
                        <button onclick="app.downloadBlank()" class="px-4 py-2 bg-white border border-slate-300 rounded text-sm font-bold text-slate-700 hover:bg-slate-50">
                            <i class="fas fa-file-pdf mr-2"></i> Blank Exam
                        </button>
                        <button onclick="location.reload()" class="px-4 py-2 bg-blue-600 text-white rounded text-sm font-bold hover:bg-blue-700">
                            New Exam
                        </button>
                    </div>

                    <div id="res-breakdown" class="p-8 space-y-8">
                        <!-- Questions with Explanations -->
                    </div>
                </div>
            </div>

            <!-- 5. ADMIN VIEW -->
            <div id="view-admin" class="hidden max-w-6xl mx-auto">
                <!-- Login -->
                <div id="admin-login" class="max-w-md mx-auto bg-white p-8 rounded-xl shadow mt-20">
                    <h2 class="text-xl font-bold mb-4">Admin Login</h2>
                    <input type="password" id="admin-pass" class="w-full p-2 border rounded mb-4" placeholder="Password">
                    <button onclick="app.checkAdmin()" class="w-full bg-slate-800 text-white py-2 rounded font-bold">Login</button>
                </div>

                <!-- Dashboard -->
                <div id="admin-dash" class="hidden space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-slate-800">Instructor Dashboard</h2>
                        <button onclick="location.reload()" class="text-red-500 font-bold text-sm">Exit</button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Submissions -->
                        <div class="bg-white rounded-lg shadow border border-slate-200 col-span-2">
                            <div class="p-4 border-b font-bold bg-slate-50">Student Submissions</div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-slate-50 text-slate-500 uppercase text-xs">
                                        <tr><th class="px-4 py-2">Name</th><th class="px-4 py-2">Event</th><th class="px-4 py-2">Score</th></tr>
                                    </thead>
                                    <tbody id="admin-table">
                                        <tr><td colspan="3" class="p-4 text-center text-slate-400">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Bulk Upload -->
                        <div class="bg-white rounded-lg shadow border border-slate-200 p-6">
                            <h3 class="font-bold mb-2">Bulk Upload</h3>
                            <p class="text-xs text-slate-500 mb-2">Paste text questions here.</p>
                            <textarea class="w-full h-40 border rounded p-2 text-xs font-mono mb-2"></textarea>
                            <button class="w-full bg-green-600 text-white py-2 rounded text-sm font-bold">Upload</button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- DATA CONSTANTS ---
        const CLUSTERS = {
            "Business Administration Core": ["Principles of Business Management", "Principles of Entrepreneurship", "Principles of Finance", "Principles of Hospitality and Tourism", "Principles of Marketing"],
            "Business Management & Administration": ["Business Law and Ethics Team Decision Making", "Human Resources Management Series"],
            "Entrepreneurship": ["Entrepreneurship Series", "Entrepreneurship Team Decision Making"],
            "Finance": ["Accounting Applications Series", "Business Finance Series", "Financial Consulting", "Financial Services Team Decision Making"],
            "Hospitality & Tourism": ["Hospitality and Tourism Professional Selling", "Hospitality Services Team Decision Making", "Hotel and Lodging Management Series", "Quick Serve Restaurant Management Series", "Restaurant and Food Service Management Series", "Travel and Tourism Team Decision Making"],
            "Marketing": ["Apparel and Accessories Marketing Series", "Automotive Services Marketing Series", "Business Services Marketing Series", "Buying and Merchandising Team Decision Making", "Food Marketing Series", "Integrated Marketing Campaign-Event", "Integrated Marketing Campaign-Product", "Integrated Marketing Campaign-Service", "Marketing Communications Series", "Marketing Management Team Decision Making", "Professional Selling", "Retail Merchandising Series", "Sports and Entertainment Marketing Series", "Sports and Entertainment Marketing Team Decision Making"],
            "Personal Financial Literacy": ["Personal Financial Literacy Event"]
        };

        const CORE_AREAS = ["Business Law", "Communications", "Customer Relations", "Economics", "Emotional Intelligence", "Financial Analysis", "Human Resources Management", "Information Management", "Marketing", "Operations", "Professional Development", "Strategic Management"];
        const AREAS_MAP = {
            "Business Administration Core": [...CORE_AREAS, "Entrepreneurship"],
            "Business Management & Administration": [...CORE_AREAS, "Knowledge Management", "Project Management", "Quality Management", "Risk Management"],
            "Entrepreneurship": [...CORE_AREAS, "Channel Management", "Market Planning", "Marketing-Information Management", "Pricing", "Product/Service Management", "Promotion", "Quality Management", "Risk Management", "Selling"],
            "Finance": [...CORE_AREAS, "Compliance", "Financial-Information Management", "Risk Management"],
            "Hospitality & Tourism": [...CORE_AREAS, "Distribution", "Knowledge Management", "Market Planning", "Pricing", "Product/Service Management", "Promotion", "Quality Management", "Risk Management", "Selling"],
            "Marketing": [...CORE_AREAS, "Channel Management", "Market Planning", "Marketing-Information Management", "Pricing", "Product/Service Management", "Promotion", "Selling"],
            "Personal Financial Literacy": ["Earning Income", "Spending", "Saving", "Investing", "Managing Credit", "Managing Risk"]
        };

        const API_KEYS = [
            "AIzaSyAwyzXApAPhT8YHcA7iAKa_-Kj-PNTMjEU",
            "AIzaSyCBl4v1EeAfAMZCkFJgSmwJCkgp_qrJk-Q",
            "AIzaSyB2LNbJuLxghaYWzC1XmLb9SM_xnF1Wauk",
            "AIzaSyCQ3tFzWK9D33SRhZA_636pekc_v9ljwbQ",
            "AIzaSyBRNjHoFQxTy6LgvdxJRLO884FndHaqszM",
            "AIzaSyD2AsWc9C-s6k5NHdwotSlG5-5VvQVeHPk",
            "AIzaSyAtaLRQUleWBqrmaRiBrmg7y6o9HITvb9E",
            "AIzaSyAm1YWAi-9h9kVuo7V8WGJJO7CBwgquXng",
            "AIzaSyBB-iTvJSIzdyJgiRpl3BP3-o-2rVNX0m0",
            "AIzaSyCGJYrzwEaqNxB-U4MfKNSxWlUd8R8pPRY"
        ];
        
        let currentKeyIndex = Math.floor(Math.random() * API_KEYS.length);

        // --- APP CONTROLLER ---
        const app = {
            state: {
                questions: [],
                answers: {},
                flagged: new Set(),
                idx: 0,
                timer: 5400,
                timerInt: null,
                meta: {}
            },

            init: function() {
                const cSel = document.getElementById('sel-cluster');
                for(let c in CLUSTERS) {
                    let opt = document.createElement('option');
                    opt.value = c; opt.textContent = c;
                    cSel.appendChild(opt);
                }
                
                cSel.addEventListener('change', (e) => {
                    const eSel = document.getElementById('sel-event');
                    eSel.innerHTML = "";
                    eSel.disabled = false;
                    CLUSTERS[e.target.value].forEach(ev => {
                        let o = document.createElement('option');
                        o.value = ev; o.textContent = ev;
                        eSel.appendChild(o);
                    });
                });
            },

            // --- NAVIGATION ---
            showView: function(view) {
                ['config', 'exam', 'review', 'results', 'admin'].forEach(v => document.getElementById('view-'+v).classList.add('hidden'));
                document.getElementById('view-'+view).classList.remove('hidden');
                
                const sb = document.getElementById('sidebar');
                if(view === 'exam' || view === 'review') sb.classList.remove('hidden', 'md:flex'); 
                else sb.classList.add('hidden');
                
                if(view === 'exam') sb.classList.add('md:flex');
            },

            // --- EXAM GENERATION ---
            startExam: async function() {
                const cluster = document.getElementById('sel-cluster').value;
                const event = document.getElementById('sel-event').value;
                const level = document.getElementById('sel-level').value;
                const count = parseInt(document.getElementById('sel-count').value);
                const name = document.getElementById('inp-name').value || "Student";

                if(!cluster || !event) return alert("Select Cluster and Event");

                this.state.meta = { cluster, event, level, count, name };
                
                const status = document.getElementById('status-msg');
                const errBox = document.getElementById('error-msg');
                status.textContent = "AI is generating unique questions... (Approx 10s)";
                status.classList.remove('hidden');
                errBox.classList.add('hidden');

                try {
                    const areas = AREAS_MAP[cluster];
                    const prompt = `Generate ${count} multiple-choice questions for a DECA ${level} Exam (${cluster} - ${event}). 
                    Focus on these areas: ${areas.join(', ')}.
                    Return strictly valid JSON array. Each object: { "text": "Question?", "options": ["A","B","C","D"], "correctIndex": 0-3, "area": "Area Name", "explanation": "Why correct" }`;

                    const data = await this.callGemini(prompt);
                    
                    if (!data) throw new Error("No data returned from API.");

                    // Clean JSON string - Handle various Markdown code block formats
                    let clean = data.trim();
                    if (clean.startsWith('```json')) {
                        clean = clean.replace(/^```json/, '').replace(/```$/, '');
                    } else if (clean.startsWith('```')) {
                         clean = clean.replace(/^```/, '').replace(/```$/, '');
                    }
                    
                    this.state.questions = JSON.parse(clean);
                    
                    this.state.idx = 0;
                    this.state.answers = {};
                    this.state.flagged.clear();
                    
                    this.startTimer();
                    this.renderQuestion();
                    this.renderNav();
                    document.getElementById('timer-box').classList.remove('hidden');
                    this.showView('exam');

                } catch(e) {
                    console.error(e);
                    errBox.textContent = "Generation Failed: " + e.message;
                    errBox.classList.remove('hidden');
                } finally {
                    status.classList.add('hidden');
                }
            },

            callGemini: async function(prompt) {
                // Round Robin Logic
                for (let attempt = 0; attempt < API_KEYS.length; attempt++) {
                    const key = API_KEYS[currentKeyIndex];
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
                    
                    try {
                        const res = await fetch(url, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });

                        // Rotate on rate limit or quota errors
                        if (res.status === 429 || res.status === 403 || res.status === 503) {
                            console.warn(`Key ${currentKeyIndex} failed (Status ${res.status}). Rotating...`);
                            currentKeyIndex = (currentKeyIndex + 1) % API_KEYS.length;
                            continue;
                        }

                        if (!res.ok) {
                            const err = await res.json().catch(() => ({}));
                            throw new Error(err.error?.message || `API Status ${res.status}`);
                        }
                        
                        const json = await res.json();
                        if (!json.candidates || !json.candidates[0].content) {
                            throw new Error("Invalid response structure from API");
                        }
                        return json.candidates[0].content.parts[0].text;

                    } catch (e) {
                        console.warn(`Attempt ${attempt + 1} failed: ${e.message}`);
                        if (attempt === API_KEYS.length - 1) throw new Error("All API keys failed. Please check connection/quota.");
                        currentKeyIndex = (currentKeyIndex + 1) % API_KEYS.length; // Rotate for next attempt
                    }
                }
            },

            // --- RUNTIME ---
            startTimer: function() {
                clearInterval(this.state.timerInt);
                this.state.timer = 90 * 60;
                this.state.timerInt = setInterval(() => {
                    this.state.timer--;
                    let m = Math.floor(this.state.timer/60);
                    let s = this.state.timer%60;
                    document.getElementById('timer-display').textContent = `${m}:${s<10?'0'+s:s}`;
                    if(this.state.timer <= 0) this.submit();
                }, 1000);
            },

            renderQuestion: function() {
                const q = this.state.questions[this.state.idx];
                document.getElementById('q-area').textContent = q.area;
                document.getElementById('q-num').textContent = this.state.idx + 1;
                document.getElementById('q-total').textContent = this.state.questions.length;
                document.getElementById('q-text').textContent = q.text;

                const con = document.getElementById('q-options');
                con.innerHTML = "";
                q.options.forEach((opt, i) => {
                    const div = document.createElement('div');
                    const isSel = this.state.answers[this.state.idx] === i;
                    div.className = `option-card p-4 border rounded-lg cursor-pointer flex gap-3 items-center border-slate-200 bg-white ${isSel ? 'selected' : ''}`;
                    div.innerHTML = `<div class="w-6 h-6 rounded border flex items-center justify-center text-xs font-bold ${isSel ? 'bg-blue-600 text-white border-blue-600' : 'text-slate-400'}">${String.fromCharCode(65+i)}</div><span>${opt}</span>`;
                    div.onclick = () => { this.state.answers[this.state.idx] = i; this.renderQuestion(); this.renderNav(); };
                    con.appendChild(div);
                });

                // Flag
                const isFlg = this.state.flagged.has(this.state.idx);
                document.getElementById('btn-flag').className = isFlg ? "text-red-500" : "text-slate-300 hover:text-red-500";
            },

            renderNav: function() {
                const grid = document.getElementById('nav-grid');
                grid.innerHTML = "";
                this.state.questions.forEach((_, i) => {
                    const div = document.createElement('div');
                    let cls = "h-8 w-full border rounded flex items-center justify-center text-xs font-bold cursor-pointer transition nav-item ";
                    
                    if(i === this.state.idx) cls += "active ";
                    else cls += "bg-white border-slate-200 text-slate-500 hover:border-blue-300 ";

                    if(this.state.answers[i] !== undefined) cls += "answered ";
                    if(this.state.flagged.has(i)) cls += "flagged ";

                    div.className = cls;
                    div.textContent = i+1;
                    div.onclick = () => { this.state.idx = i; this.renderQuestion(); this.showView('exam'); };
                    grid.appendChild(div);
                });
            },

            nav: function(dir) {
                const n = this.state.idx + dir;
                if(n >= 0 && n < this.state.questions.length) {
                    this.state.idx = n;
                    this.renderQuestion();
                    this.renderNav();
                }
            },

            toggleFlag: function() {
                const i = this.state.idx;
                this.state.flagged.has(i) ? this.state.flagged.delete(i) : this.state.flagged.add(i);
                this.renderQuestion();
                this.renderNav();
            },

            cancelExam: function() {
                if(confirm("Exit exam? Progress will be lost.")) {
                    this.state.questions = [];
                    this.state.answers = {};
                    clearInterval(this.state.timerInt);
                    document.getElementById('timer-box').classList.add('hidden');
                    this.showView('config');
                }
            },

            // --- REVIEW & SUBMIT ---
            showReview: function() {
                this.showView('review');
                const grid = document.getElementById('review-grid');
                grid.innerHTML = "";
                this.state.questions.forEach((q, i) => {
                    const ans = this.state.answers[i] !== undefined;
                    const flg = this.state.flagged.has(i);
                    const d = document.createElement('div');
                    d.className = "bg-white p-4 rounded-lg border border-slate-200 shadow-sm flex justify-between items-center cursor-pointer hover:border-blue-400";
                    d.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-slate-500 w-6">#${i+1}</span>
                            <span class="text-xs uppercase text-slate-400 font-bold truncate w-24">${q.area}</span>
                        </div>
                        <div class="flex gap-2 text-sm">
                            ${flg ? '<i class="fas fa-flag text-red-500"></i>' : ''}
                            ${ans ? '<i class="fas fa-check-circle text-green-500"></i>' : '<span class="text-orange-500 font-bold text-[10px] bg-orange-50 px-2 rounded">SKIP</span>'}
                        </div>
                    `;
                    d.onclick = () => { this.state.idx = i; this.showView('exam'); this.renderQuestion(); };
                    grid.appendChild(d);
                });
            },

            resume: function() { this.showView('exam'); },

            submit: function() {
                if(!confirm("Submit Exam?")) return;
                
                clearInterval(this.state.timerInt);
                document.getElementById('timer-box').classList.add('hidden');
                
                // Grade
                let correct = 0;
                const details = this.state.questions.map((q, i) => {
                    const u = this.state.answers[i];
                    const right = u === q.correctIndex;
                    if(right) correct++;
                    return { ...q, user: u, correct: right };
                });
                
                const score = Math.round((correct / this.state.questions.length) * 100);
                
                // Display
                document.getElementById('res-score').textContent = score + "%";
                document.getElementById('res-detail').textContent = `${correct}/${this.state.questions.length} Correct`;
                
                const con = document.getElementById('res-breakdown');
                con.innerHTML = "";
                details.forEach((d, i) => {
                    const div = document.createElement('div');
                    div.className = `p-6 bg-white rounded-xl border-l-4 shadow-sm ${d.correct ? 'border-green-500' : 'border-red-500'}`;
                    div.innerHTML = `
                        <div class="flex justify-between mb-2">
                            <span class="text-[10px] font-bold uppercase text-slate-400 tracking-wide">${d.area}</span>
                            ${d.correct ? '<span class="text-green-600 font-bold text-xs">CORRECT</span>' : '<span class="text-red-600 font-bold text-xs">INCORRECT</span>'}
                        </div>
                        <p class="font-bold text-slate-800 mb-3">${i+1}. ${d.text}</p>
                        <div class="space-y-1 mb-3 text-sm">
                            ${d.options.map((o, idx) => `
                                <div class="p-2 rounded ${idx === d.correctIndex ? 'bg-green-100 text-green-800 font-bold' : (idx === d.user ? 'bg-red-100 text-red-800 line-through' : 'text-slate-500')}">
                                    ${String.fromCharCode(65+idx)}) ${o}
                                </div>
                            `).join('')}
                        </div>
                        <div class="bg-slate-50 p-3 rounded text-xs text-slate-600 border border-slate-100">
                            <strong>Explanation:</strong> ${d.explanation}
                        </div>
                    `;
                    con.appendChild(div);
                });

                // Save
                if(window.saveExam) {
                    window.saveExam({
                        student: this.state.meta.name,
                        event: this.state.meta.event,
                        score: score,
                        details: details // Save for analytics
                    });
                }

                this.showView('results');
            },

            // --- PRINT/PDF ---
            downloadBlank: function() {
                const el = document.createElement('div');
                el.innerHTML = `
                    <div style="padding:40px; font-family:sans-serif;">
                        <h1 style="text-align:center; font-weight:bold; font-size:24px; margin-bottom:10px">DECA ${this.state.meta.event} Exam</h1>
                        <p style="text-align:center; margin-bottom:30px">Name: ____________________ | Score: ____ / ${this.state.questions.length}</p>
                        ${this.state.questions.map((q, i) => `
                            <div style="margin-bottom:20px; page-break-inside: avoid;">
                                <p style="font-weight:bold; font-size:14px; margin-bottom:5px">${i+1}. ${q.text}</p>
                                <div style="margin-left:15px; font-size:12px;">
                                    ${q.options.map((o, idx) => `<div style="margin-bottom:2px">___ ${String.fromCharCode(65+idx)}) ${o}</div>`).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                html2pdf().set({ margin:0.5, filename:`${this.state.meta.event}_Exam.pdf`}).from(el).save();
            },

            printResults: function() { window.print(); },

            // --- ADMIN ---
            toggleAdmin: function() {
                if(document.getElementById('view-admin').classList.contains('hidden')) {
                    this.showView('admin');
                    document.getElementById('admin-login').classList.remove('hidden');
                    document.getElementById('admin-dash').classList.add('hidden');
                } else {
                    this.showView('config');
                }
            },

            checkAdmin: function() {
                if(document.getElementById('admin-pass').value === "deca") {
                    document.getElementById('admin-login').classList.add('hidden');
                    document.getElementById('admin-dash').classList.remove('hidden');
                    this.loadAdmin();
                } else {
                    document.getElementById('adminError').classList.remove('hidden');
                }
            },

            loadAdmin: async function() {
                const tb = document.getElementById('admin-table');
                tb.innerHTML = "<tr><td colspan='3' class='p-4 text-center'>Loading...</td></tr>";
                const data = await window.loadSubmissions();
                tb.innerHTML = "";
                data.forEach(r => {
                    const tr = document.createElement('tr');
                    tr.className = "bg-white border-b hover:bg-slate-50";
                    tr.innerHTML = `<td class="px-4 py-2 font-bold">${r.student}</td><td class="px-4 py-2 text-xs">${r.event}</td><td class="px-4 py-2 font-mono text-blue-600">${r.score}%</td>`;
                    tb.appendChild(tr);
                });
            }
        };

        // Start
        app.init();
    </script>
</body>
</html>
